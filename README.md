
# Here this!

`here-this` is a simple wrapper script around `tmux` 
to easily launch a (long running) command
in a background tmux session.


For example, Python 3 has a built-in simple HTTP server
(invoked with `python -m http.server`)
to statically serve your current working directory.
Because it runs in an infinite loop,
it will hijack your current shell session until you kill it.

`here-this` allows to launch it 
in a background tmux session instead, 
offering these features:

- your interactive shell **isn't hijacked** by a long running process
- while it feels like launching something in the background,
  you can still **re-attach** to the tmux session
  and interact with the process **interactively**,
  e.g. scroll through the stdout/stderr logs, enter a password,
  kill the process, ...


Of course, any operating system worth its salt provides
"big boy" tools for running background services 
and daemons (init, systemd, launchd, ...)
but sometimes you just want a quick and ~~dirty~~ easy
solution to run something ad-hoc in a semi-background fashion.


## Dependencies

`here-this.py` is a simple Python script and requires:

- **Python 3.5** or higher. 
  The script just uses the Python standard library,
  so it not necessary to set up some sort of virtual env.
- **`tmux`, the terminal multiplexer**, to do the real work.
  This tool is usually not available by default,
  so install it through the package manager of your OS.
  
## Installation

Because it is a simple one-file Python script, you can just put
it in a location that is convenient for your workflow.
Use some combination of the following tips as desired:

- copy or symlink `here-this.py` to a destination folder
  of your liking (e.g. in your `PATH`)
- drop the `.py` extension, if you don't like that cruft 
  in command line tools.
- adapt the shebang (`#!`) line at the top of the script
  to the desired Python executable.

## Usage

### Basics

You can use `here-this` directly by passing it a command,
like this:

    here-this.py python3 -m http.server

which will respond with something like this:

    Starting new tmux session 'here-this-python3mhttpserv-pathtosomewhere' in background with command 'python3 -m http.server'
    Launched new tmux session with initial output:
    ----------------------------------------------------------------------
    Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
    
    ----------------------------------------------------------------------
    To re-attach:
        tmux attach -t here-this-python3mhttpserv-pathtosomewhere
    To dump latest output/logs:
        tmux capture-pane -p -t here-this-python3mhttpserv-pathtosomewhere

This example illustrates a couple of things that `here-this` provides:

- a descriptive tmux **session name** is automatically derived 
  from the command and working directory
- the **initial output** of the command is shown 
- example commands are shown of how to **re-attach** 
  or get a **dump the latest output**


### Multiple commands

You can also pass multiple commands as a single string snippet:

    here-this.py 'for i in 1 2 3; do echo $i hello; sleep $i; done'

### Scripts and aliases

To make reuse easier you probably want to put these things
in reusable scripts and/or create aliases.

The `python3 -m http.server` example is simple enough to make 
a direct alias like:

    # Full, explicit version
    alias here-http='python3 ~/src/here-this/here-this.py python3 -m http.server'

    # Short version, assuming the appropriate shortcuts are in place
    alias here-http='here-this python3 -m http.server'

If there are more commands in play, 
you probably want to put them in a small (bash) script first
and create an alias like this:

    alias here-jupyter='python3 ~/src/here-this/here-this.py bash ~/src/scripts/here-jupiter.sh'


### Shebang trick

Instead of aliases (which are shell specific),
you can also leverage a [shebang trick](https://en.wikipedia.org/wiki/Shebang_(Unix)) 
(a script's first line starting with `#!`) 
to use `here-this` when invoking a script.
Shebangs are a bit limited feature-wise and portability is challenging,
but something like this should work:

    #!/usr/bin/env -S python3 /absolute/path/to/here-this.py bash
    
    python3 -m http.server


## Autogenerated session name

The automatically generated session name makes it easier to find out
what a `here-this`-created tmux session is about
when you have multiple of them around.

Also, `here-this` will detect if you are already 
running the given command (from same folder)
and just show you its current status instead of launching it again:

    $ here-this.py python3 -m http.server
    tmux session 'here-this-python3mhttpserv-pathtosomewhere' is already running.
    Current output:
    ----------------------------------------------------------------------
    Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
    127.0.0.1 - - [09/Aug/2020 17:38:12] "GET / HTTP/1.1" 200 -
    ...


## Examples

The `examples` folder has some inspiration and example scripts to use
with `here-this`.


## Troubleshooting

When a command fails in your `here-this` tmux session,
it can be challenging to troubleshoot. 
When your script exits (due to failure), tmux also exits immediately, 
so any helpful error message is also lost by default.

It can help to put a `sleep` as last command in your script
to make sure that `here-http` has time to capture the error message
as "initial output". For example:

    $ here-this.py 'python -c "x = 42 / 0"; sleep 3'
    ...
    Launched new tmux session with initial output:
    ----------------------------------------------------------------------
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
    ZeroDivisionError: division by zero
